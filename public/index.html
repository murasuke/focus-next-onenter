<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>move focus on enter event</title>
    <meta name="description" content="move focus on enter event" />
  </head>
  <body>
    <form id="form">
      <table>
        <tr>
          <td>
            <input type="text" value="no tabindex" />
          </td>
          <td>            
            <input type="text" tabindex="1" value="tabindex is 1" />
          </td>
          <td>            
            <a href="" >no tabindex</a>
          </td>
        </tr>
        <tr>
          <td>            
            <input type="text" tabindex="0" value="tabindex is 0"/>
          </td>
          <td>
            <input type="text" tabindex="-1" value="tabindex is -1" />
          </td>
          <td>            
            <textarea>tabindex is blank</textarea>
          </td>
        </tr>
        <tr>
          <td>
            <input type="text" tabindex="-2" value="tabindex is -2"/>
          </td>
          <td>
            <input type="text" tabindex="3" value="tabindex is 3" />
          </td>
          <td tabindex="3">
            <p tabindex="2">&lt;p&gt; tabindex is 2&lt;/p&gt;</p>  
          </td>
        </tr>
        <tr>
          <td>
            <input type="text" value="no tabindex" />
          </td>
          <td>
            <input type="text" tabindex="3" value="tabindex is 3" hidden />
          </td>
          <td>            
            <input type="text" tabindex="" value="tabindex is blank" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" tabindex="2" value="tabindex is 2"/>
          </td>
          <td>
            <input type="button" value="no tabindex" disabled />
          </td>
          <td>            
            <input type="button" tabindex="" value="tabindex is blank" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="radio" name="radio" tabindex="2" value="tabindex is 2"/>
            <input type="radio" name="radio1" tabindex="2" value="tabindex is 2" checked/>
            <input type="radio" name="radio" tabindex="2" value="tabindex is 2"/>
          </td>
          <td>
            <select>
              <option value="dog">Dog</option>
              <option value="cat">Cat</option>
            </select>
          </td>
          <td>            
            <input type="checkbox"  tabindex="2" value="tabindex is 2"/>
            <input type="checkbox"  tabindex="2" value="tabindex is 2" checked/>
            <input type="checkbox"  tabindex="2" value="tabindex is 2"/>
          </td>
        </tr>
      </table>
    </form>
    <pre>
  フォーカスを持つことが可能なタグ
    ・input, button, select, textarea, a
     ※上記以外でも、tabindex属性をつければフォーカス移動対象となる

     ・下記のように入れ子になっている場合、両方がフォーカス移動対象(tabindex順)
     　⇒&lt;td tabindex="2"&gt;&lt;input type="" tabindex="1" &gt;&lt;/td&gt;
  ①tabindex(1以上)の順に移動 ⇒ 最大まで行ったらtabindex未指定をDOM出現に移動 ⇒ URL入力欄に移動
  ②同じtabindexが複数ある場合はDOM出現順に移動
  ③tabindex=0は未指定と同じ
  ④tabindexがマイナスの項目にフォーカスがある場合、次項目はDOM出現順に移動可能な項目へ移動
  ⑤移動可能：tabindex指定なし、もしくは0以上

  ・anchorには移動しない（Enterでリンク先へ移動してしまうので）
    </pre>
    <script>

      const enterHandler = ({ prevNode, node, nextNode }) => {
        node.addEventListener('keypress', keyEvent => {
          // Only continue if event.key was "Enter"
          if (keyEvent.key !== "Enter") return;

          const nextTarget = keyEvent.shiftKey ? prevNode : nextNode;
          if (!nextTarget) return;
          
          // Don't submit
          keyEvent.preventDefault();
          // To prevent multiple calls to events when they are nested
          keyEvent.stopPropagation();

          // Do the thing
          nextTarget.focus();

          // Not all elements have a select method
          if (typeof nextTarget.select === 'function') nextTarget.select();
        });
      };


      document.addEventListener('DOMContentLoaded', () => {
        // フォーカス可能なElementと、tabindex属性があるElementを一括で取得する
        //  (tabindexがあると、フォーカスを持つことができるため対象とする)
        const nodeList = document.querySelectorAll(`
          #form input:not([disabled])[type]:not([type=\"hidden\"]):not([hidden]),
          #form select:not([disabled]):not([hidden]),
          #form button:not([disabled])[type=\"submit\"]:not([hidden]),
          #form textarea:not([disabled]):not([hidden]),
          #form [tabindex]:not([disabled]):not([hidden])
        `);
        // const nodeList = document.querySelectorAll(`
        //   #form input:not([disabled])[type]:not([type="hidden"]):not([hidden])
        // `);
        
        // The return value of querySelectorAll() is not an array. Converted to array for ease of use.
        const nodeArray = Array.prototype.slice.call(nodeList);

        // Sort is a destructive method, so copy by spread Syntax
        // Sort by tabindex (move backwards for unspecified Elements)
        const tabSortedArray = [...nodeArray].sort((a,b) => {
          if(a.tabIndex && b.tabIndex) {
            return a.tabIndex - b.tabIndex; 
          } else if(a.tabIndex && !b.tabIndex) {
            return -1;
          } else if(!a.tabIndex && b.tabIndex) {
            return 1;
          }
          return 0;
        });

        const positiveveArray = [...tabSortedArray].filter( item => item.tabIndex >= 0);
        const negativeArray = [...tabSortedArray].filter( item => item.tabIndex < 0);

        positiveveArray.forEach( (node, i, array) => enterHandler({
            prevNode: array[i - 1] ?? array.slice(-1)[0],
            node,
            nextNode: array[i + 1] ?? array[0],
          })
        );

        negativeArray.forEach((node, i, array) => enterHandler({
            prevNode: nodeArray[nodeArray.findIndex(element => element === node) - 1] ?? positiveveArray.slice(-1)[0],
            node,
            nextNode: nodeArray[nodeArray.findIndex(element => element === node) + 1] ?? positiveveArray[0],
          })
        );
      });
    </script>
      
  </body>
</html>